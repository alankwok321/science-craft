<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Science Craft ‚öóÔ∏è</title>
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
    background: #0a0e1a;
    color: #e0e0e0;
    height: 100vh;
    overflow: hidden;
    user-select: none;
  }

  #header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 12px 24px;
    background: linear-gradient(135deg, #0d1117, #161b22);
    border-bottom: 1px solid #21262d;
    z-index: 100;
    position: relative;
  }

  #header h1 {
    font-size: 1.4rem;
    font-weight: 700;
    background: linear-gradient(135deg, #58a6ff, #bc8cff);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
  }

  #header-right {
    display: flex;
    align-items: center;
    gap: 16px;
  }

  #stats {
    font-size: 0.85rem;
    color: #8b949e;
  }

  #stats span {
    color: #58a6ff;
    font-weight: 600;
  }

  .header-btn {
    padding: 6px 14px;
    border-radius: 8px;
    border: 1px solid #30363d;
    background: #161b22;
    color: #8b949e;
    font-size: 0.8rem;
    cursor: pointer;
    transition: all 0.15s;
  }

  .header-btn:hover {
    border-color: #58a6ff;
    color: #58a6ff;
  }

  .header-btn.active {
    border-color: #58a6ff;
    color: #58a6ff;
    background: rgba(88, 166, 255, 0.1);
  }

  #main {
    display: flex;
    height: calc(100vh - 52px);
  }

  /* Sidebar */
  #sidebar {
    width: 280px;
    min-width: 280px;
    background: #0d1117;
    border-right: 1px solid #21262d;
    display: flex;
    flex-direction: column;
    z-index: 10;
  }

  #search-box {
    padding: 10px 12px;
    border-bottom: 1px solid #21262d;
  }

  #search-box input {
    width: 100%;
    padding: 8px 12px;
    border-radius: 8px;
    border: 1px solid #30363d;
    background: #161b22;
    color: #e0e0e0;
    font-size: 0.85rem;
    outline: none;
    transition: border-color 0.2s;
  }

  #search-box input:focus {
    border-color: #58a6ff;
  }

  #element-list {
    flex: 1;
    overflow-y: auto;
    padding: 8px;
  }

  #element-list::-webkit-scrollbar { width: 6px; }
  #element-list::-webkit-scrollbar-track { background: transparent; }
  #element-list::-webkit-scrollbar-thumb { background: #30363d; border-radius: 3px; }

  .sidebar-item {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 6px 12px;
    margin: 3px;
    border-radius: 20px;
    background: #161b22;
    border: 1px solid #21262d;
    font-size: 0.82rem;
    cursor: grab;
    transition: all 0.15s;
    white-space: nowrap;
  }

  .sidebar-item:hover {
    border-color: #58a6ff;
    background: #1a2233;
    transform: translateY(-1px);
  }

  .sidebar-item:active { cursor: grabbing; }

  .sidebar-item .emoji { font-size: 1rem; }

  .new-badge {
    animation: glow 1.5s ease-in-out;
  }

  @keyframes glow {
    0%, 100% { box-shadow: none; }
    50% { box-shadow: 0 0 12px rgba(88, 166, 255, 0.5); }
  }

  /* Canvas */
  #canvas {
    flex: 1;
    position: relative;
    overflow: hidden;
    background:
      radial-gradient(circle at 20% 50%, rgba(88, 166, 255, 0.03) 0%, transparent 50%),
      radial-gradient(circle at 80% 50%, rgba(188, 140, 255, 0.03) 0%, transparent 50%),
      #0a0e1a;
  }

  #canvas-bg {
    position: absolute;
    inset: 0;
    background-image:
      radial-gradient(circle, #1a1f2e 1px, transparent 1px);
    background-size: 30px 30px;
    opacity: 0.4;
    pointer-events: none;
  }

  .element-chip {
    position: absolute;
    display: flex;
    align-items: center;
    gap: 6px;
    padding: 8px 16px;
    border-radius: 24px;
    background: linear-gradient(135deg, #161b22, #1c2333);
    border: 1.5px solid #30363d;
    font-size: 0.9rem;
    font-weight: 500;
    cursor: grab;
    white-space: nowrap;
    z-index: 5;
    transition: box-shadow 0.2s, border-color 0.2s;
  }

  .element-chip:hover {
    border-color: #58a6ff;
    box-shadow: 0 4px 20px rgba(88, 166, 255, 0.15);
  }

  .element-chip:active { cursor: grabbing; }

  .element-chip .emoji { font-size: 1.15rem; }

  .element-chip .remove {
    margin-left: 4px;
    opacity: 0;
    font-size: 0.7rem;
    color: #8b949e;
    cursor: pointer;
    transition: opacity 0.2s;
  }

  .element-chip:hover .remove { opacity: 0.7; }
  .element-chip .remove:hover { opacity: 1; color: #f85149; }

  /* Merge animation */
  .merging {
    animation: merge-pulse 0.4s ease-out;
  }

  @keyframes merge-pulse {
    0% { transform: scale(1); }
    50% { transform: scale(1.15); box-shadow: 0 0 30px rgba(88, 166, 255, 0.4); }
    100% { transform: scale(1); }
  }

  .result-pop {
    animation: pop-in 0.35s cubic-bezier(0.34, 1.56, 0.64, 1);
  }

  @keyframes pop-in {
    0% { transform: scale(0); opacity: 0; }
    100% { transform: scale(1); opacity: 1; }
  }

  /* Combo text */
  .combo-text {
    position: absolute;
    font-size: 0.75rem;
    color: #58a6ff;
    font-weight: 600;
    pointer-events: none;
    animation: float-up 1.2s ease-out forwards;
    z-index: 50;
  }

  @keyframes float-up {
    0% { opacity: 1; transform: translateY(0); }
    100% { opacity: 0; transform: translateY(-40px); }
  }

  .first-discovery {
    color: #f0c040 !important;
    font-size: 0.85rem !important;
  }

  /* Bottom buttons */
  #clear-btn {
    position: fixed;
    bottom: 20px;
    right: 20px;
    padding: 10px 20px;
    border-radius: 12px;
    border: 1px solid #30363d;
    background: #161b22;
    color: #8b949e;
    font-size: 0.85rem;
    cursor: pointer;
    z-index: 20;
    transition: all 0.2s;
  }

  #clear-btn:hover {
    border-color: #f85149;
    color: #f85149;
  }

  #reset-btn {
    position: fixed;
    bottom: 20px;
    right: 140px;
    padding: 10px 20px;
    border-radius: 12px;
    border: 1px solid #30363d;
    background: #161b22;
    color: #8b949e;
    font-size: 0.85rem;
    cursor: pointer;
    z-index: 20;
    transition: all 0.2s;
  }

  #reset-btn:hover {
    border-color: #f85149;
    color: #f85149;
  }

  /* Tooltip */
  #tooltip {
    display: none;
    position: fixed;
    padding: 6px 12px;
    border-radius: 8px;
    background: #1c2333;
    border: 1px solid #30363d;
    font-size: 0.78rem;
    color: #8b949e;
    pointer-events: none;
    z-index: 200;
    max-width: 250px;
  }

  /* ========== OVERLAY PANELS ========== */
  .overlay {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(0, 0, 0, 0.6);
    z-index: 500;
    justify-content: center;
    align-items: center;
    backdrop-filter: blur(4px);
  }

  .overlay.open {
    display: flex;
  }

  .panel {
    background: #0d1117;
    border: 1px solid #21262d;
    border-radius: 16px;
    width: 90%;
    max-width: 750px;
    max-height: 85vh;
    display: flex;
    flex-direction: column;
    overflow: hidden;
    animation: panel-in 0.25s ease-out;
  }

  @keyframes panel-in {
    0% { transform: scale(0.95); opacity: 0; }
    100% { transform: scale(1); opacity: 1; }
  }

  .panel-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 16px 20px;
    border-bottom: 1px solid #21262d;
  }

  .panel-header h2 {
    font-size: 1.15rem;
    font-weight: 700;
    color: #e0e0e0;
  }

  .panel-close {
    background: none;
    border: none;
    color: #8b949e;
    font-size: 1.2rem;
    cursor: pointer;
    padding: 4px 8px;
    border-radius: 6px;
    transition: all 0.15s;
  }

  .panel-close:hover {
    background: #161b22;
    color: #f85149;
  }

  .panel-search {
    padding: 12px 20px;
    border-bottom: 1px solid #21262d;
  }

  .panel-search input {
    width: 100%;
    padding: 8px 12px;
    border-radius: 8px;
    border: 1px solid #30363d;
    background: #161b22;
    color: #e0e0e0;
    font-size: 0.85rem;
    outline: none;
  }

  .panel-search input:focus {
    border-color: #58a6ff;
  }

  .panel-body {
    flex: 1;
    overflow-y: auto;
    padding: 16px 20px;
  }

  .panel-body::-webkit-scrollbar { width: 6px; }
  .panel-body::-webkit-scrollbar-track { background: transparent; }
  .panel-body::-webkit-scrollbar-thumb { background: #30363d; border-radius: 3px; }

  /* ===== Combinations Log ===== */
  .combo-log-item {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 10px 14px;
    margin-bottom: 6px;
    border-radius: 10px;
    background: #161b22;
    border: 1px solid #21262d;
    font-size: 0.85rem;
    transition: border-color 0.15s;
  }

  .combo-log-item:hover {
    border-color: #30363d;
  }

  .combo-part {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    padding: 3px 10px;
    border-radius: 14px;
    background: #1c2333;
    border: 1px solid #30363d;
    font-size: 0.8rem;
  }

  .combo-plus {
    color: #8b949e;
    font-weight: 600;
  }

  .combo-arrow {
    color: #58a6ff;
    font-weight: 700;
    font-size: 1rem;
  }

  .combo-result {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    padding: 3px 10px;
    border-radius: 14px;
    background: rgba(88, 166, 255, 0.1);
    border: 1px solid rgba(88, 166, 255, 0.3);
    font-size: 0.8rem;
    color: #58a6ff;
    font-weight: 600;
  }

  .combo-log-empty {
    text-align: center;
    color: #8b949e;
    padding: 40px 20px;
    font-size: 0.9rem;
  }

  /* ===== Dictionary ===== */
  .dict-tabs {
    display: flex;
    gap: 6px;
    padding: 12px 20px;
    border-bottom: 1px solid #21262d;
    flex-wrap: wrap;
  }

  .dict-tab {
    padding: 5px 12px;
    border-radius: 14px;
    border: 1px solid #30363d;
    background: #161b22;
    color: #8b949e;
    font-size: 0.78rem;
    cursor: pointer;
    transition: all 0.15s;
  }

  .dict-tab:hover {
    border-color: #58a6ff;
    color: #58a6ff;
  }

  .dict-tab.active {
    border-color: #58a6ff;
    background: rgba(88, 166, 255, 0.1);
    color: #58a6ff;
  }

  .dict-card {
    padding: 14px 16px;
    margin-bottom: 8px;
    border-radius: 12px;
    background: #161b22;
    border: 1px solid #21262d;
    transition: border-color 0.15s;
    cursor: pointer;
  }

  .dict-card:hover {
    border-color: #30363d;
  }

  .dict-card.expanded {
    border-color: #58a6ff;
  }

  .dict-card-header {
    display: flex;
    align-items: center;
    gap: 10px;
  }

  .dict-emoji {
    font-size: 1.5rem;
    width: 36px;
    text-align: center;
  }

  .dict-info {
    flex: 1;
  }

  .dict-name {
    font-weight: 600;
    font-size: 0.95rem;
  }

  .dict-cat {
    font-size: 0.72rem;
    color: #8b949e;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-top: 1px;
  }

  .dict-desc {
    font-size: 0.82rem;
    color: #8b949e;
    margin-top: 2px;
  }

  .dict-badge {
    font-size: 0.7rem;
    padding: 2px 8px;
    border-radius: 10px;
    background: rgba(88, 166, 255, 0.1);
    color: #58a6ff;
    border: 1px solid rgba(88, 166, 255, 0.2);
  }

  .dict-badge.locked {
    background: rgba(139, 148, 158, 0.1);
    color: #8b949e;
    border-color: rgba(139, 148, 158, 0.2);
  }

  .dict-detail {
    display: none;
    margin-top: 12px;
    padding-top: 12px;
    border-top: 1px solid #21262d;
  }

  .dict-card.expanded .dict-detail {
    display: block;
  }

  .dict-detail h4 {
    font-size: 0.78rem;
    color: #8b949e;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-bottom: 8px;
  }

  .dict-recipe-row {
    display: flex;
    align-items: center;
    gap: 6px;
    padding: 6px 0;
    font-size: 0.82rem;
  }

  .dict-recipe-row .combo-part {
    font-size: 0.75rem;
  }

  .dict-makes-label {
    margin-top: 12px;
  }

  .cat-chemistry { color: #79c0ff; }
  .cat-physics { color: #d2a8ff; }
  .cat-biology { color: #7ee787; }
  .cat-earth { color: #d29922; }
  .cat-space { color: #f778ba; }
  .cat-tech { color: #ff7b72; }
  .cat-fundamental { color: #ffa657; }

  /* Mobile */
  @media (max-width: 640px) {
    #sidebar { width: 100%; min-width: 100%; max-height: 35vh; border-right: none; border-bottom: 1px solid #21262d; }
    #main { flex-direction: column; }
    #canvas { min-height: 65vh; }
    .panel { width: 96%; max-height: 90vh; }
    #header { padding: 10px 14px; flex-wrap: wrap; gap: 8px; }
    #header-right { gap: 8px; }
  }
</style>
</head>
<body>

<div id="header">
  <h1>‚öóÔ∏è Science Craft</h1>
  <div id="header-right">
    <div id="stats">Discovered: <span id="count">4</span> / <span id="total">???</span></div>
    <button class="header-btn" onclick="togglePanel('combos')">üìã Combinations</button>
    <button class="header-btn" onclick="togglePanel('dict')">üìñ Dictionary</button>
  </div>
</div>

<div id="main">
  <div id="sidebar">
    <div id="search-box">
      <input type="text" id="search" placeholder="üîç Search elements...">
    </div>
    <div id="element-list"></div>
  </div>
  <div id="canvas">
    <div id="canvas-bg"></div>
  </div>
</div>

<button id="clear-btn" onclick="clearCanvas()">üßπ Clear Board</button>
<button id="reset-btn" onclick="resetGame()">üîÑ Reset All</button>
<div id="tooltip"></div>

<!-- ===== COMBINATIONS PANEL ===== -->
<div class="overlay" id="combos-overlay" onclick="closePanelOutside(event, 'combos')">
  <div class="panel">
    <div class="panel-header">
      <h2>üìã Discovered Combinations</h2>
      <button class="panel-close" onclick="togglePanel('combos')">‚úï</button>
    </div>
    <div class="panel-search">
      <input type="text" id="combo-search" placeholder="üîç Search combinations..." oninput="renderCombos()">
    </div>
    <div class="panel-body" id="combos-body"></div>
  </div>
</div>

<!-- ===== DICTIONARY PANEL ===== -->
<div class="overlay" id="dict-overlay" onclick="closePanelOutside(event, 'dict')">
  <div class="panel">
    <div class="panel-header">
      <h2>üìñ Science Dictionary</h2>
      <button class="panel-close" onclick="togglePanel('dict')">‚úï</button>
    </div>
    <div class="dict-tabs" id="dict-tabs">
      <button class="dict-tab active" data-cat="all" onclick="setDictTab('all')">All</button>
      <button class="dict-tab" data-cat="fundamental" onclick="setDictTab('fundamental')">‚öõÔ∏è Fundamental</button>
      <button class="dict-tab" data-cat="chemistry" onclick="setDictTab('chemistry')">üß™ Chemistry</button>
      <button class="dict-tab" data-cat="physics" onclick="setDictTab('physics')">‚ö° Physics</button>
      <button class="dict-tab" data-cat="biology" onclick="setDictTab('biology')">üß¨ Biology</button>
      <button class="dict-tab" data-cat="earth" onclick="setDictTab('earth')">üåç Earth</button>
      <button class="dict-tab" data-cat="space" onclick="setDictTab('space')">üåå Space</button>
      <button class="dict-tab" data-cat="tech" onclick="setDictTab('tech')">üíª Tech</button>
    </div>
    <div class="panel-search">
      <input type="text" id="dict-search" placeholder="üîç Search dictionary..." oninput="renderDict()">
    </div>
    <div class="panel-body" id="dict-body"></div>
  </div>
</div>

<script>
// ========== SCIENCE CRAFT ENGINE ==========

const ELEMENTS = {
  "Atom":       { emoji: "‚öõÔ∏è", cat: "fundamental", desc: "The building block of all matter" },
  "Energy":     { emoji: "‚ö°", cat: "physics",      desc: "The capacity to do work" },
  "Water":      { emoji: "üíß", cat: "chemistry",    desc: "H‚ÇÇO ‚Äî the universal solvent" },
  "Earth":      { emoji: "ü™®", cat: "earth",        desc: "Solid ground, rocks and minerals" },
  "Molecule":   { emoji: "üî¨", cat: "chemistry",    desc: "Two or more atoms bonded together" },
  "Heat":       { emoji: "üî•", cat: "physics",      desc: "Thermal energy in motion" },
  "Pressure":   { emoji: "ü´∏", cat: "physics",      desc: "Force per unit area" },
  "Mineral":    { emoji: "üíé", cat: "earth",        desc: "Naturally occurring inorganic solid" },
  "Steam":      { emoji: "‚ô®Ô∏è", cat: "chemistry",    desc: "Water in gaseous phase" },
  "Mud":        { emoji: "üü§", cat: "earth",        desc: "Wet earth, a slurry of minerals" },
  "Wave":       { emoji: "üåä", cat: "physics",      desc: "A disturbance transferring energy" },
  "Ion":        { emoji: "üîã", cat: "chemistry",    desc: "An atom with net electric charge" },
  "Cell":       { emoji: "üß´", cat: "biology",      desc: "The basic unit of life" },
  "Metal":      { emoji: "üî©", cat: "chemistry",    desc: "Conductive, malleable element" },
  "Crystal":    { emoji: "‚ú®", cat: "earth",        desc: "Ordered atomic lattice structure" },
  "Gas":        { emoji: "üí®", cat: "chemistry",    desc: "Matter with no fixed shape or volume" },
  "Electricity":{ emoji: "üîå", cat: "physics",      desc: "Flow of electric charge" },
  "Acid":       { emoji: "üß™", cat: "chemistry",    desc: "Proton donor, pH < 7" },
  "Magma":      { emoji: "üåã", cat: "earth",        desc: "Molten rock beneath Earth's surface" },
  "Light":      { emoji: "üí°", cat: "physics",      desc: "Electromagnetic radiation visible to eyes" },
  "Sound":      { emoji: "üîä", cat: "physics",      desc: "Mechanical wave through a medium" },
  "Erosion":    { emoji: "üèúÔ∏è", cat: "earth",        desc: "Gradual wearing away by water and wind" },
  "Solution":   { emoji: "ü´ó", cat: "chemistry",    desc: "Homogeneous mixture of solute in solvent" },
  "Plasma":     { emoji: "üü£", cat: "physics",      desc: "Ionized gas ‚Äî the fourth state of matter" },
  "Bacteria":   { emoji: "ü¶†", cat: "biology",      desc: "Single-celled prokaryotic organism" },
  "Virus":      { emoji: "üß¨", cat: "biology",      desc: "Infectious agent requiring a host cell" },
  "DNA":        { emoji: "üß¨", cat: "biology",      desc: "Double helix carrying genetic code" },
  "Photosynthesis": { emoji: "üåø", cat: "biology",  desc: "Light energy ‚Üí chemical energy in plants" },
  "Magnet":     { emoji: "üß≤", cat: "physics",      desc: "Object producing a magnetic field" },
  "Alloy":      { emoji: "‚öôÔ∏è", cat: "chemistry",    desc: "Mixture of metals with enhanced properties" },
  "Volcano":    { emoji: "üåã", cat: "earth",        desc: "Rupture in the crust releasing magma" },
  "Fossil":     { emoji: "ü¶¥", cat: "earth",        desc: "Preserved remains of ancient organisms" },
  "Polymer":    { emoji: "üîó", cat: "chemistry",    desc: "Long chain of repeating molecular units" },
  "Semiconductor": { emoji: "üìü", cat: "physics",   desc: "Material with conductivity between metal and insulator" },
  "Lens":       { emoji: "üîç", cat: "physics",      desc: "Transparent piece that refracts light" },
  "Enzyme":     { emoji: "ü´ß", cat: "biology",      desc: "Biological catalyst speeding up reactions" },
  "Salt":       { emoji: "üßÇ", cat: "chemistry",    desc: "Ionic compound from acid-base reaction" },
  "Radiation":  { emoji: "‚ò¢Ô∏è", cat: "physics",      desc: "Emission of energy as waves or particles" },
  "Earthquake": { emoji: "üì≥", cat: "earth",        desc: "Sudden release of energy in the crust" },
  "Cloud":      { emoji: "‚òÅÔ∏è", cat: "earth",        desc: "Visible mass of water droplets in the atmosphere" },
  "Evolution":  { emoji: "üêí", cat: "biology",      desc: "Change in heritable traits over generations" },
  "Genome":     { emoji: "üìñ", cat: "biology",      desc: "Complete set of genetic instructions" },
  "Telescope":  { emoji: "üî≠", cat: "physics",      desc: "Optical instrument for observing distant objects" },
  "Microscope": { emoji: "üî¨", cat: "physics",      desc: "Instrument to magnify the very small" },
  "Computer":   { emoji: "üíª", cat: "tech",         desc: "Programmable electronic computation device" },
  "Laser":      { emoji: "üì°", cat: "physics",      desc: "Coherent amplified light beam" },
  "Nuclear Fission": { emoji: "üí•", cat: "physics",  desc: "Splitting heavy nuclei to release energy" },
  "Nuclear Fusion":  { emoji: "‚òÄÔ∏è", cat: "physics",  desc: "Merging light nuclei ‚Äî powers the stars" },
  "Vaccine":    { emoji: "üíâ", cat: "biology",      desc: "Biological preparation providing immunity" },
  "Antibiotic": { emoji: "üíä", cat: "biology",      desc: "Substance that kills or inhibits bacteria" },
  "Plastic":    { emoji: "ü•§", cat: "chemistry",    desc: "Synthetic polymer ‚Äî moldable and durable" },
  "Superconductor": { emoji: "‚ùÑÔ∏è", cat: "physics",  desc: "Zero electrical resistance at low temperature" },
  "Lightning":  { emoji: "‚ö°", cat: "physics",      desc: "Massive electrostatic discharge in atmosphere" },
  "Rain":       { emoji: "üåßÔ∏è", cat: "earth",        desc: "Liquid water falling from clouds" },
  "Tectonic Plate": { emoji: "üó∫Ô∏è", cat: "earth",   desc: "Massive slab of Earth's lithosphere" },
  "Photon":     { emoji: "‚ú¥Ô∏è", cat: "physics",      desc: "Quantum of electromagnetic radiation" },
  "Star":       { emoji: "‚≠ê", cat: "space",        desc: "Luminous sphere of plasma held by gravity" },
  "Catalyst":   { emoji: "‚è©", cat: "chemistry",    desc: "Speeds up reaction without being consumed" },
  "Black Hole": { emoji: "üï≥Ô∏è", cat: "space",       desc: "Spacetime region where gravity prevents escape" },
  "Supernova":  { emoji: "üí´", cat: "space",        desc: "Explosive death of a massive star" },
  "Neutron Star": { emoji: "üåë", cat: "space",      desc: "Ultra-dense remnant of a supernova" },
  "Planet":     { emoji: "ü™ê", cat: "space",        desc: "Celestial body orbiting a star" },
  "Galaxy":     { emoji: "üåå", cat: "space",        desc: "Vast system of stars, gas, and dark matter" },
  "Nebula":     { emoji: "üå´Ô∏è", cat: "space",        desc: "Interstellar cloud of gas and dust" },
  "AI":         { emoji: "ü§ñ", cat: "tech",         desc: "Artificial intelligence ‚Äî machines that think" },
  "Robot":      { emoji: "ü¶æ", cat: "tech",         desc: "Programmable machine performing tasks" },
  "Quantum Computer": { emoji: "üîÆ", cat: "tech",   desc: "Computes using quantum mechanical phenomena" },
  "CRISPR":     { emoji: "‚úÇÔ∏è", cat: "biology",      desc: "Gene editing tool from bacterial immune system" },
  "Cloning":    { emoji: "üêë", cat: "biology",      desc: "Creating genetically identical organisms" },
  "Penicillin": { emoji: "üçÑ", cat: "biology",      desc: "First true antibiotic, from Penicillium mold" },
  "Rocket":     { emoji: "üöÄ", cat: "tech",         desc: "Vehicle propelled by expelled mass (Newton's 3rd)" },
  "Solar Panel":{ emoji: "üîÜ", cat: "tech",         desc: "Converts photons into electricity" },
  "MRI":        { emoji: "üè•", cat: "tech",         desc: "Magnetic resonance imaging of the body" },
  "Particle Accelerator": { emoji: "üîÑ", cat: "tech", desc: "Propels particles to near light speed" },
  "Dark Matter":{ emoji: "üåë", cat: "space",        desc: "Invisible mass holding galaxies together" },
  "Gravity Wave":{ emoji: "„Ä∞Ô∏è", cat: "space",      desc: "Ripple in spacetime from massive acceleration" },
  "Ecosystem":  { emoji: "üåç", cat: "biology",      desc: "Community of organisms and their environment" },
  "Climate":    { emoji: "üå°Ô∏è", cat: "earth",        desc: "Long-term pattern of weather in an area" },
  "Ocean":      { emoji: "üåä", cat: "earth",        desc: "Vast body of saltwater covering the Earth" },
  "Atmosphere": { emoji: "üåê", cat: "earth",        desc: "Layer of gases surrounding a planet" },
  "Petroleum":  { emoji: "üõ¢Ô∏è", cat: "earth",        desc: "Fossil fuel from ancient organic matter" },
  "Diamond":    { emoji: "üíé", cat: "earth",        desc: "Carbon allotrope ‚Äî hardest natural material" },
  "Nanotechnology": { emoji: "üî¨", cat: "tech",     desc: "Engineering at the atomic/molecular scale" },
  "Relativity": { emoji: "üïê", cat: "physics",      desc: "Einstein's theory ‚Äî spacetime and mass-energy" },
  "Quantum Mechanics": { emoji: "üé≤", cat: "physics", desc: "Physics of the very small ‚Äî probabilistic" },
  "Big Bang":   { emoji: "üí•", cat: "space",        desc: "The origin of the universe ~13.8 billion years ago" },
  "Theory of Everything": { emoji: "üåå", cat: "physics", desc: "Hypothetical framework unifying all forces" },
  "Wormhole":   { emoji: "üï≥Ô∏è", cat: "space",       desc: "Theoretical tunnel through spacetime" },
  "Dyson Sphere": { emoji: "‚≠ï", cat: "space",      desc: "Megastructure enclosing a star for total energy capture" },
  "Terraforming": { emoji: "üèóÔ∏è", cat: "space",     desc: "Engineering a planet to support life" },
  "Singularity": { emoji: "‚ôæÔ∏è", cat: "tech",        desc: "Point where AI surpasses human intelligence" },
};

const RECIPES = [
  ["Atom", "Atom", "Molecule"],
  ["Energy", "Atom", "Ion"],
  ["Energy", "Energy", "Heat"],
  ["Earth", "Earth", "Pressure"],
  ["Water", "Energy", "Wave"],
  ["Water", "Earth", "Mud"],
  ["Water", "Heat", "Steam"],
  ["Earth", "Pressure", "Mineral"],
  ["Molecule", "Water", "Cell"],
  ["Molecule", "Molecule", "Polymer"],
  ["Mineral", "Heat", "Metal"],
  ["Mineral", "Pressure", "Crystal"],
  ["Steam", "Energy", "Gas"],
  ["Ion", "Energy", "Electricity"],
  ["Ion", "Water", "Acid"],
  ["Earth", "Heat", "Magma"],
  ["Energy", "Wave", "Light"],
  ["Wave", "Pressure", "Sound"],
  ["Water", "Wave", "Erosion"],
  ["Water", "Atom", "Solution"],
  ["Ion", "Heat", "Plasma"],
  ["Water", "Mud", "Solution"],
  ["Heat", "Atom", "Plasma"],
  ["Cell", "Cell", "Bacteria"],
  ["Cell", "Molecule", "Virus"],
  ["Cell", "Acid", "DNA"],
  ["Cell", "Light", "Photosynthesis"],
  ["Metal", "Electricity", "Magnet"],
  ["Metal", "Metal", "Alloy"],
  ["Magma", "Earth", "Volcano"],
  ["Mud", "Pressure", "Fossil"],
  ["Earth", "Mud", "Fossil"],
  ["Crystal", "Electricity", "Semiconductor"],
  ["Crystal", "Light", "Lens"],
  ["Cell", "Energy", "Enzyme"],
  ["Acid", "Mineral", "Salt"],
  ["Energy", "Atom", "Radiation"],
  ["Light", "Energy", "Radiation"],
  ["Pressure", "Earth", "Earthquake"],
  ["Pressure", "Pressure", "Earthquake"],
  ["Steam", "Gas", "Cloud"],
  ["Water", "Gas", "Cloud"],
  ["Molecule", "Energy", "Catalyst"],
  ["DNA", "DNA", "Genome"],
  ["Bacteria", "DNA", "Evolution"],
  ["Cell", "DNA", "Evolution"],
  ["Lens", "Lens", "Telescope"],
  ["Lens", "Light", "Microscope"],
  ["Crystal", "Lens", "Microscope"],
  ["Semiconductor", "Electricity", "Computer"],
  ["Light", "Crystal", "Laser"],
  ["Light", "Lens", "Laser"],
  ["Atom", "Radiation", "Nuclear Fission"],
  ["Plasma", "Pressure", "Nuclear Fusion"],
  ["Atom", "Pressure", "Nuclear Fusion"],
  ["Virus", "Enzyme", "Vaccine"],
  ["Bacteria", "Enzyme", "Antibiotic"],
  ["Polymer", "Heat", "Plastic"],
  ["Metal", "Crystal", "Superconductor"],
  ["Electricity", "Cloud", "Lightning"],
  ["Cloud", "Water", "Rain"],
  ["Cloud", "Pressure", "Rain"],
  ["Earthquake", "Earth", "Tectonic Plate"],
  ["Light", "Atom", "Photon"],
  ["Light", "Energy", "Photon"],
  ["Plasma", "Nuclear Fusion", "Star"],
  ["Heat", "Plasma", "Star"],
  ["Star", "Pressure", "Black Hole"],
  ["Star", "Star", "Supernova"],
  ["Star", "Energy", "Supernova"],
  ["Supernova", "Pressure", "Neutron Star"],
  ["Star", "Earth", "Planet"],
  ["Star", "Mineral", "Planet"],
  ["Star", "Star", "Galaxy"],
  ["Supernova", "Star", "Galaxy"],
  ["Gas", "Star", "Nebula"],
  ["Cloud", "Star", "Nebula"],
  ["Computer", "Computer", "AI"],
  ["Computer", "Evolution", "AI"],
  ["Computer", "Metal", "Robot"],
  ["Alloy", "Computer", "Robot"],
  ["Computer", "Photon", "Quantum Computer"],
  ["Computer", "Atom", "Quantum Computer"],
  ["DNA", "Enzyme", "CRISPR"],
  ["Genome", "Laser", "CRISPR"],
  ["DNA", "DNA", "Cloning"],
  ["Genome", "Cell", "Cloning"],
  ["Bacteria", "Mud", "Penicillin"],
  ["Antibiotic", "Bacteria", "Penicillin"],
  ["Gas", "Heat", "Rocket"],
  ["Pressure", "Metal", "Rocket"],
  ["Photon", "Semiconductor", "Solar Panel"],
  ["Light", "Semiconductor", "Solar Panel"],
  ["Magnet", "Computer", "MRI"],
  ["Magnet", "Wave", "MRI"],
  ["Electricity", "Magnet", "Particle Accelerator"],
  ["Energy", "Atom", "Particle Accelerator"],
  ["Galaxy", "Pressure", "Dark Matter"],
  ["Supernova", "Wave", "Gravity Wave"],
  ["Black Hole", "Wave", "Gravity Wave"],
  ["Cell", "Water", "Ecosystem"],
  ["Bacteria", "Photosynthesis", "Ecosystem"],
  ["Rain", "Earth", "Ecosystem"],
  ["Cloud", "Heat", "Climate"],
  ["Atmosphere", "Heat", "Climate"],
  ["Water", "Salt", "Ocean"],
  ["Wave", "Salt", "Ocean"],
  ["Gas", "Earth", "Atmosphere"],
  ["Gas", "Pressure", "Atmosphere"],
  ["Fossil", "Pressure", "Petroleum"],
  ["Fossil", "Heat", "Petroleum"],
  ["Crystal", "Pressure", "Diamond"],
  ["Crystal", "Heat", "Diamond"],
  ["Atom", "Microscope", "Nanotechnology"],
  ["Robot", "Microscope", "Nanotechnology"],
  ["Light", "Gravity Wave", "Relativity"],
  ["Energy", "Photon", "Relativity"],
  ["Photon", "Atom", "Quantum Mechanics"],
  ["Wave", "Atom", "Quantum Mechanics"],
  ["Big Bang", "Big Bang", "Theory of Everything"],
  ["Quantum Mechanics", "Relativity", "Theory of Everything"],
  ["Singularity", "Relativity", "Wormhole"],
  ["Black Hole", "Black Hole", "Wormhole"],
  ["Star", "Rocket", "Dyson Sphere"],
  ["Star", "Solar Panel", "Dyson Sphere"],
  ["Planet", "Ecosystem", "Terraforming"],
  ["Planet", "Rocket", "Terraforming"],
  ["AI", "AI", "Singularity"],
  ["AI", "Evolution", "Singularity"],
  ["Energy", "Pressure", "Big Bang"],
  ["Nuclear Fusion", "Nuclear Fusion", "Big Bang"],
];

// ========== GAME STATE ==========
const BASE_ELEMENTS = ["Atom", "Energy", "Water", "Earth"];
let discovered = new Set(BASE_ELEMENTS);
let discoveredCombos = []; // [{a, b, result, timestamp}]
let chipIdCounter = 0;
let dragState = null;
let currentDictTab = 'all';

// ========== PERSISTENCE ==========
function loadState() {
  try {
    const saved = localStorage.getItem('scicraft_discovered');
    if (saved) {
      const arr = JSON.parse(saved);
      discovered = new Set([...BASE_ELEMENTS, ...arr.filter(n => ELEMENTS[n])]);
    }
    const savedCombos = localStorage.getItem('scicraft_combos');
    if (savedCombos) {
      discoveredCombos = JSON.parse(savedCombos);
    }
  } catch(e) {}
}

function saveState() {
  localStorage.setItem('scicraft_discovered', JSON.stringify([...discovered]));
  localStorage.setItem('scicraft_combos', JSON.stringify(discoveredCombos));
}

// ========== RECIPE LOOKUP ==========
const recipeMap = new Map();
RECIPES.forEach(([a, b, result]) => {
  recipeMap.set(`${a}|${b}`, result);
  recipeMap.set(`${b}|${a}`, result);
});

function combine(a, b) {
  return recipeMap.get(`${a}|${b}`) || null;
}

// Build reverse lookup: for each element, what recipes produce it, and what can it make
function getRecipesFor(name) {
  const madeBy = [];
  const makes = [];
  RECIPES.forEach(([a, b, result]) => {
    if (result === name) madeBy.push([a, b]);
    if (a === name || b === name) makes.push([a, b, result]);
  });
  return { madeBy, makes };
}

// ========== SIDEBAR ==========
function renderSidebar(filter = '') {
  const list = document.getElementById('element-list');
  const f = filter.toLowerCase();
  const sorted = [...discovered].sort((a, b) => a.localeCompare(b));

  list.innerHTML = sorted
    .filter(name => name.toLowerCase().includes(f))
    .map(name => {
      const el = ELEMENTS[name];
      return `<div class="sidebar-item" draggable="true" data-name="${name}"
                   title="${el.desc}">
                <span class="emoji">${el.emoji}</span>${name}
              </div>`;
    }).join('');

  document.getElementById('count').textContent = discovered.size;

  list.querySelectorAll('.sidebar-item').forEach(item => {
    item.addEventListener('mousedown', (e) => sidebarDragStart(e, item.dataset.name));
    item.addEventListener('touchstart', (e) => sidebarDragStart(e, item.dataset.name), { passive: false });
  });
}

// ========== CANVAS CHIPS ==========
function createChipOnCanvas(name, x, y, animate = false) {
  const el = ELEMENTS[name];
  if (!el) return;

  const chip = document.createElement('div');
  chip.className = 'element-chip' + (animate ? ' result-pop' : '');
  chip.dataset.chipId = chipIdCounter++;
  chip.dataset.name = name;
  chip.style.left = x + 'px';
  chip.style.top = y + 'px';
  chip.innerHTML = `<span class="emoji">${el.emoji}</span>${name}<span class="remove">‚úï</span>`;

  chip.querySelector('.remove').addEventListener('click', (e) => {
    e.stopPropagation();
    chip.remove();
  });

  chip.addEventListener('mousedown', (e) => chipDragStart(e, chip));
  chip.addEventListener('touchstart', (e) => chipDragStart(e, chip), { passive: false });

  document.getElementById('canvas').appendChild(chip);
  return chip;
}

// ========== DRAG & DROP ==========
function getPos(e) {
  const t = e.touches ? e.touches[0] : e;
  return { x: t.clientX, y: t.clientY };
}

function sidebarDragStart(e, name) {
  e.preventDefault();
  const pos = getPos(e);
  const canvas = document.getElementById('canvas');
  const rect = canvas.getBoundingClientRect();

  const chip = createChipOnCanvas(name, pos.x - rect.left - 40, pos.y - rect.top - 16);
  if (!chip) return;

  dragState = { chip, offsetX: 40, offsetY: 16, canvasRect: rect, fromSidebar: true };
}

function chipDragStart(e, chip) {
  if (e.target.classList.contains('remove')) return;
  e.preventDefault();
  const pos = getPos(e);
  const canvas = document.getElementById('canvas');
  const rect = canvas.getBoundingClientRect();
  const chipRect = chip.getBoundingClientRect();

  dragState = {
    chip,
    offsetX: pos.x - chipRect.left,
    offsetY: pos.y - chipRect.top,
    canvasRect: rect,
    fromSidebar: false
  };
  chip.style.zIndex = 50;
}

function onMove(e) {
  if (!dragState) return;
  e.preventDefault();
  const pos = getPos(e);
  const { chip, offsetX, offsetY, canvasRect } = dragState;
  chip.style.left = (pos.x - canvasRect.left - offsetX) + 'px';
  chip.style.top = (pos.y - canvasRect.top - offsetY) + 'px';
}

function onEnd(e) {
  if (!dragState) return;
  const { chip } = dragState;
  chip.style.zIndex = 5;

  const chipRect = chip.getBoundingClientRect();
  const allChips = document.querySelectorAll('.element-chip');

  for (const other of allChips) {
    if (other === chip) continue;
    const otherRect = other.getBoundingClientRect();
    if (rectsOverlap(chipRect, otherRect)) {
      attemptMerge(chip, other);
      break;
    }
  }

  dragState = null;
}

function rectsOverlap(a, b) {
  return !(a.right < b.left || a.left > b.right || a.bottom < b.top || a.top > b.bottom);
}

function attemptMerge(chipA, chipB) {
  const nameA = chipA.dataset.name;
  const nameB = chipB.dataset.name;
  const result = combine(nameA, nameB);

  if (!result) {
    showComboText(chipA, "‚ùå No reaction", false);
    return;
  }

  const isNew = !discovered.has(result);
  discovered.add(result);

  // Log combination
  const comboKey = [nameA, nameB].sort().join('|') + '‚Üí' + result;
  const alreadyLogged = discoveredCombos.some(c =>
    [c.a, c.b].sort().join('|') + '‚Üí' + c.result === comboKey
  );
  if (!alreadyLogged) {
    discoveredCombos.push({
      a: nameA,
      b: nameB,
      result,
      timestamp: Date.now(),
      isFirst: isNew
    });
  }

  saveState();

  const ax = parseFloat(chipA.style.left), ay = parseFloat(chipA.style.top);
  const bx = parseFloat(chipB.style.left), by = parseFloat(chipB.style.top);
  const rx = (ax + bx) / 2, ry = (ay + by) / 2;

  chipA.remove();
  chipB.remove();

  const resultChip = createChipOnCanvas(result, rx, ry, true);

  const el = ELEMENTS[result];
  const label = isNew ? `‚ú® NEW: ${el.emoji} ${result}!` : `${el.emoji} ${result}`;
  showComboText(resultChip, label, isNew);

  if (isNew) {
    renderSidebar(document.getElementById('search').value);
  }
}

function showComboText(chip, text, isFirst) {
  const canvas = document.getElementById('canvas');
  const div = document.createElement('div');
  div.className = 'combo-text' + (isFirst ? ' first-discovery' : '');
  div.textContent = text;
  div.style.left = chip.style.left;
  div.style.top = (parseFloat(chip.style.top) - 10) + 'px';
  canvas.appendChild(div);
  setTimeout(() => div.remove(), 1300);
}

// ========== PANELS ==========
function togglePanel(name) {
  const overlay = document.getElementById(name + '-overlay');
  const isOpen = overlay.classList.contains('open');

  // Close all
  document.querySelectorAll('.overlay').forEach(o => o.classList.remove('open'));
  document.querySelectorAll('.header-btn').forEach(b => b.classList.remove('active'));

  if (!isOpen) {
    overlay.classList.add('open');
    // Highlight button
    const btns = document.querySelectorAll('.header-btn');
    if (name === 'combos') btns[0].classList.add('active');
    if (name === 'dict') btns[1].classList.add('active');

    if (name === 'combos') renderCombos();
    if (name === 'dict') renderDict();
  }
}

function closePanelOutside(e, name) {
  if (e.target === document.getElementById(name + '-overlay')) {
    togglePanel(name);
  }
}

// ========== COMBINATIONS LOG ==========
function renderCombos() {
  const body = document.getElementById('combos-body');
  const filter = (document.getElementById('combo-search').value || '').toLowerCase();

  const filtered = discoveredCombos.filter(c => {
    const text = `${c.a} ${c.b} ${c.result}`.toLowerCase();
    return text.includes(filter);
  });

  if (filtered.length === 0) {
    body.innerHTML = `<div class="combo-log-empty">
      ${discoveredCombos.length === 0
        ? 'üß™ No combinations discovered yet.<br>Drag two elements together to combine them!'
        : 'üîç No matches found.'}
    </div>`;
    return;
  }

  body.innerHTML = filtered.slice().reverse().map(c => {
    const elA = ELEMENTS[c.a], elB = ELEMENTS[c.b], elR = ELEMENTS[c.result];
    return `<div class="combo-log-item">
      <span class="combo-part">${elA.emoji} ${c.a}</span>
      <span class="combo-plus">+</span>
      <span class="combo-part">${elB.emoji} ${c.b}</span>
      <span class="combo-arrow">‚Üí</span>
      <span class="combo-result">${elR.emoji} ${c.result}</span>
    </div>`;
  }).join('');
}

// ========== DICTIONARY ==========
function setDictTab(cat) {
  currentDictTab = cat;
  document.querySelectorAll('.dict-tab').forEach(t => {
    t.classList.toggle('active', t.dataset.cat === cat);
  });
  renderDict();
}

function renderDict() {
  const body = document.getElementById('dict-body');
  const filter = (document.getElementById('dict-search').value || '').toLowerCase();

  const allNames = Object.keys(ELEMENTS).sort((a, b) => a.localeCompare(b));

  const filtered = allNames.filter(name => {
    const el = ELEMENTS[name];
    if (currentDictTab !== 'all' && el.cat !== currentDictTab) return false;
    if (filter && !name.toLowerCase().includes(filter) && !el.desc.toLowerCase().includes(filter)) return false;
    return true;
  });

  if (filtered.length === 0) {
    body.innerHTML = '<div class="combo-log-empty">üîç No elements found.</div>';
    return;
  }

  body.innerHTML = filtered.map(name => {
    const el = ELEMENTS[name];
    const isDiscovered = discovered.has(name);
    const { madeBy, makes } = getRecipesFor(name);

    // Only show discovered recipes
    const knownMadeBy = madeBy.filter(([a, b]) => discovered.has(a) && discovered.has(b) && discovered.has(name));
    const knownMakes = makes.filter(([a, b, r]) => discovered.has(a) && discovered.has(b) && discovered.has(r));

    const catClass = 'cat-' + el.cat;

    return `<div class="dict-card" onclick="this.classList.toggle('expanded')">
      <div class="dict-card-header">
        <div class="dict-emoji">${isDiscovered ? el.emoji : '‚ùì'}</div>
        <div class="dict-info">
          <div class="dict-name">${isDiscovered ? name : '???'}</div>
          <div class="dict-cat ${catClass}">${el.cat}</div>
          ${isDiscovered ? `<div class="dict-desc">${el.desc}</div>` : ''}
        </div>
        <div class="dict-badge ${isDiscovered ? '' : 'locked'}">${isDiscovered ? '‚úì Discovered' : 'üîí Locked'}</div>
      </div>
      ${isDiscovered ? `<div class="dict-detail">
        ${knownMadeBy.length > 0 ? `
          <h4>üì• How to make</h4>
          ${knownMadeBy.map(([a, b]) => `
            <div class="dict-recipe-row">
              <span class="combo-part">${ELEMENTS[a].emoji} ${a}</span>
              <span class="combo-plus">+</span>
              <span class="combo-part">${ELEMENTS[b].emoji} ${b}</span>
            </div>
          `).join('')}
        ` : BASE_ELEMENTS.includes(name) ? '<h4>üì• Base element ‚Äî available from the start</h4>' : '<h4>üì• Recipe not yet discovered</h4>'}
        ${knownMakes.length > 0 ? `
          <h4 class="dict-makes-label">üì§ Can be used to make</h4>
          ${knownMakes.map(([a, b, r]) => {
            const other = a === name ? b : a;
            return `<div class="dict-recipe-row">
              <span class="combo-plus">+</span>
              <span class="combo-part">${ELEMENTS[other].emoji} ${other}</span>
              <span class="combo-arrow">‚Üí</span>
              <span class="combo-result">${ELEMENTS[r].emoji} ${r}</span>
            </div>`;
          }).join('')}
        ` : ''}
      </div>` : `<div class="dict-detail">
        <h4>üîí Discover this element to see its details</h4>
      </div>`}
    </div>`;
  }).join('');
}

// ========== CONTROLS ==========
function clearCanvas() {
  document.querySelectorAll('.element-chip').forEach(c => c.remove());
  document.querySelectorAll('.combo-text').forEach(c => c.remove());
}

function resetGame() {
  if (!confirm('Reset all progress? You will lose all discovered elements and combinations.')) return;
  discovered = new Set(BASE_ELEMENTS);
  discoveredCombos = [];
  saveState();
  clearCanvas();
  renderSidebar();
}

// ========== TOOLTIP ==========
document.addEventListener('mouseover', (e) => {
  const item = e.target.closest('.sidebar-item[data-name]');
  if (!item) { document.getElementById('tooltip').style.display = 'none'; return; }
  const name = item.dataset.name;
  const el = ELEMENTS[name];
  if (!el) return;
  const tip = document.getElementById('tooltip');
  tip.textContent = el.desc;
  tip.style.display = 'block';
  const rect = item.getBoundingClientRect();
  tip.style.left = rect.right + 8 + 'px';
  tip.style.top = rect.top + 'px';
});

// ========== KEYBOARD ==========
document.addEventListener('keydown', (e) => {
  if (e.key === 'Escape') {
    document.querySelectorAll('.overlay').forEach(o => o.classList.remove('open'));
    document.querySelectorAll('.header-btn').forEach(b => b.classList.remove('active'));
  }
});

// ========== INIT ==========
document.addEventListener('mousemove', onMove);
document.addEventListener('mouseup', onEnd);
document.addEventListener('touchmove', onMove, { passive: false });
document.addEventListener('touchend', onEnd);

document.getElementById('search').addEventListener('input', (e) => {
  renderSidebar(e.target.value);
});

document.getElementById('total').textContent = Object.keys(ELEMENTS).length;

loadState();
renderSidebar();
</script>
</body>
</html>
